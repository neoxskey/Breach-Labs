import React, { useState, useEffect, useRef } from 'react';
import { Terminal, Code, Shield, Zap, Trophy, BookOpen, Network, Lock, Play, ChevronRight, CheckCircle, AlertTriangle, Star, Target, Flame, Beaker, Database, Send, Copy, Download, Eye, EyeOff, RotateCcw, Award, TrendingUp, Users, Medal, Crown, Sparkles, Gift, FileText, BarChart3, Clock, X, LogOut, User, Settings, LogIn, UserPlus } from 'lucide-react';

const CyberAcademyPro = () => {
  // Authentication State
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);
  const [showAuthModal, setShowAuthModal] = useState(false);
  const [authMode, setAuthMode] = useState('login');
  const [authForm, setAuthForm] = useState({ username: '', email: '', password: '' });
  const [authError, setAuthError] = useState('');
  const [users, setUsers] = useState([]);

  const [activeTab, setActiveTab] = useState('labs');
  const [selectedTopic, setSelectedTopic] = useState('sqli');
  const [selectedLab, setSelectedLab] = useState(null);
  const [labStarted, setLabStarted] = useState(false);
  const [requestMethod, setRequestMethod] = useState('GET');
  const [requestPath, setRequestPath] = useState('');
  const [requestBody, setRequestBody] = useState('');
  const [requestHeaders, setRequestHeaders] = useState('Cookie: session=abc123');
  const [responseData, setResponseData] = useState(null);
  const [labProgress, setLabProgress] = useState({});
  const [showSolution, setShowSolution] = useState(false);
  const [userStats, setUserStats] = useState({
    completed: 0,
    total: 27,
    points: 0,
    rank: 'Beginner',
    streak: 0,
    achievements: [],
    lastActive: new Date().toDateString(),
    labTimes: {},
    hintsUsed: {}
  });
  const [showAchievement, setShowAchievement] = useState(null);
  const [labStartTime, setLabStartTime] = useState(null);
  const [labTime, setLabTime] = useState(0);
  const [hintsRevealed, setHintsRevealed] = useState(0);
  const [showUserMenu, setShowUserMenu] = useState(false);
  const responseRef = useRef(null);

  const topics = [
    { id: 'sqli', name: 'SQL Injection', icon: Database, labs: 4, color: 'red' },
    { id: 'xss', name: 'XSS', icon: Code, labs: 3, color: 'orange' },
    { id: 'csrf', name: 'CSRF', icon: Shield, labs: 2, color: 'yellow' },
    { id: 'auth', name: 'Authentication', icon: Lock, labs: 4, color: 'blue' },
    { id: 'access', name: 'Access Control', icon: Target, labs: 4, color: 'purple' },
    { id: 'business', name: 'Business Logic', icon: Zap, labs: 4, color: 'green' },
    { id: 'ssrf', name: 'SSRF', icon: Network, labs: 3, color: 'cyan' },
    { id: 'xxe', name: 'XXE', icon: Terminal, labs: 3, color: 'pink' }
  ];

  const achievements = [
    { id: 'first_blood', name: 'First Blood', desc: 'Complete your first lab', icon: Trophy, points: 10, color: 'yellow', requirement: 1 },
    { id: 'sql_master', name: 'SQL Master', desc: 'Complete all SQL Injection labs', icon: Database, points: 50, color: 'red', requirement: 4 },
    { id: 'xss_ninja', name: 'XSS Ninja', desc: 'Complete all XSS labs', icon: Code, points: 50, color: 'orange', requirement: 3 },
    { id: 'speed_runner', name: 'Speed Runner', desc: 'Complete a lab in under 2 minutes', icon: Zap, points: 30, color: 'yellow', requirement: 1 },
    { id: 'completionist', name: 'Completionist', desc: 'Complete all 27 labs', icon: Crown, points: 500, color: 'gold', requirement: 27 }
  ];

  const ranks = [
    { name: 'Beginner', min: 0, max: 49, icon: 'üå±', color: 'gray' },
    { name: 'Apprentice', min: 50, max: 149, icon: 'üéì', color: 'green' },
    { name: 'Practitioner', min: 150, max: 299, icon: '‚öîÔ∏è', color: 'blue' },
    { name: 'Expert', min: 300, max: 499, icon: 'üî•', color: 'orange' },
    { name: 'Master', min: 500, max: 999, icon: 'üëë', color: 'purple' },
    { name: 'Legend', min: 1000, max: Infinity, icon: '‚≠ê', color: 'gold' }
  ];

  const labs = {
    sqli: [
      {
        id: 'sqli-1',
        title: 'SQL injection in WHERE clause',
        difficulty: 'apprentice',
        description: 'SQL injection vulnerability in product category filter.',
        objective: 'Display all products including unreleased ones.',
        endpoint: '/filter?category=',
        vulnerability: 'SQL Injection',
        hints: [
          "The category parameter is used directly in a SQL query",
          "Try breaking out of the quote with a single quote '",
          "Use OR 1=1 to make the condition always true",
          "Comment out the rest of the query with --",
          "Final payload: ' OR 1=1--"
        ]
      },
      {
        id: 'sqli-2',
        title: 'SQL injection login bypass',
        difficulty: 'apprentice',
        description: 'SQL injection in login functionality.',
        objective: 'Login as administrator without password.',
        endpoint: '/login',
        vulnerability: 'SQL Injection',
        hints: [
          "Username and password are used in SQL query",
          "Try username: administrator'--",
          "The -- comments out the password check",
          "Leave password field empty or any value",
          "You'll be logged in as administrator"
        ]
      },
      {
        id: 'sqli-3',
        title: 'UNION attack - column enumeration',
        difficulty: 'practitioner',
        description: 'Determine number of columns using UNION.',
        objective: 'Find the number of columns returned.',
        endpoint: '/filter?category=',
        vulnerability: 'UNION SQLi',
        hints: [
          "Use UNION SELECT to combine results",
          "Start with: ' UNION SELECT NULL--",
          "Add more NULLs until no error",
          "' UNION SELECT NULL,NULL,NULL--",
          "3 columns found when query succeeds"
        ]
      },
      {
        id: 'sqli-4',
        title: 'UNION attack - data extraction',
        difficulty: 'practitioner',
        description: 'Extract usernames and passwords from users table.',
        objective: 'Retrieve all credentials.',
        endpoint: '/filter?category=',
        vulnerability: 'UNION SQLi',
        hints: [
          "First determine column count",
          "Use UNION to select from users table",
          "' UNION SELECT username,password FROM users--",
          "Administrator credentials will appear",
          "Use them to login"
        ]
      }
    ],
    xss: [
      {
        id: 'xss-1',
        title: 'Reflected XSS',
        difficulty: 'apprentice',
        description: 'Simple reflected XSS in search.',
        objective: 'Execute alert() function.',
        endpoint: '/search?query=',
        vulnerability: 'Reflected XSS',
        hints: [
          "Search input is reflected in page",
          "Try: <script>alert(1)</script>",
          "No encoding is applied",
          "Script executes immediately",
          "Lab solved when alert triggers"
        ]
      },
      {
        id: 'xss-2',
        title: 'Stored XSS',
        difficulty: 'apprentice',
        description: 'Stored XSS in comments.',
        objective: 'Store malicious script in comment.',
        endpoint: '/post/comment',
        vulnerability: 'Stored XSS',
        hints: [
          "Comments are stored in database",
          "Submit: <script>alert(document.domain)</script>",
          "Payload stored permanently",
          "Executes for all viewers",
          "Persistent XSS attack"
        ]
      },
      {
        id: 'xss-3',
        title: 'DOM XSS',
        difficulty: 'practitioner',
        description: 'DOM-based XSS in document.write.',
        objective: 'Exploit DOM XSS vulnerability.',
        endpoint: '/search?query=',
        vulnerability: 'DOM XSS',
        hints: [
          "JavaScript uses location.search",
          "Break out of attribute context",
          'Use: "><script>alert(1)</script>',
          "Closes the tag first",
          "Then injects script"
        ]
      }
    ],
    csrf: [
      {
        id: 'csrf-1',
        title: 'CSRF with no defenses',
        difficulty: 'apprentice',
        description: 'No CSRF protection on email change.',
        objective: 'Change victim email via CSRF.',
        endpoint: '/change-email',
        vulnerability: 'CSRF',
        hints: [
          "Email change has no CSRF token",
          "Create auto-submit form",
          "Set email parameter",
          "Form submits on page load",
          "Email changed without user action"
        ]
      },
      {
        id: 'csrf-2',
        title: 'CSRF method bypass',
        difficulty: 'practitioner',
        description: 'CSRF token only checked on POST.',
        objective: 'Bypass CSRF using GET method.',
        endpoint: '/change-email',
        vulnerability: 'CSRF',
        hints: [
          "POST requests need CSRF token",
          "Try changing to GET method",
          "Token not checked for GET",
          "Use: /change-email?email=attacker@evil.com",
          "Protection bypassed"
        ]
      }
    ],
    auth: [
      {
        id: 'auth-1',
        title: 'Username enumeration',
        difficulty: 'apprentice',
        description: 'Different error messages reveal valid usernames.',
        objective: 'Enumerate valid username.',
        endpoint: '/login',
        vulnerability: 'Username Enumeration',
        hints: [
          "Try different usernames",
          "Notice error message differences",
          "Invalid username: 'Invalid username'",
          "Valid username: 'Incorrect password'",
          "Username 'carlos' is valid"
        ]
      },
      {
        id: 'auth-2',
        title: 'Password reset flaw',
        difficulty: 'apprentice',
        description: 'Broken password reset logic.',
        objective: 'Reset Carlos password.',
        endpoint: '/forgot-password',
        vulnerability: 'Broken Reset',
        hints: [
          "Initiate password reset",
          "Intercept the reset request",
          "Notice username parameter",
          "Change username to carlos",
          "Set new password for carlos"
        ]
      },
      {
        id: 'auth-3',
        title: '2FA bypass',
        difficulty: 'apprentice',
        description: '2FA can be bypassed.',
        objective: 'Access account without 2FA.',
        endpoint: '/login',
        vulnerability: '2FA Bypass',
        hints: [
          "Login with valid credentials",
          "2FA page appears",
          "Don't enter 2FA code",
          "Navigate directly to /my-account",
          "Access granted without 2FA"
        ]
      },
      {
        id: 'auth-4',
        title: 'Cookie brute force',
        difficulty: 'practitioner',
        description: 'Weak stay-logged-in cookie.',
        objective: 'Crack the cookie format.',
        endpoint: '/login',
        vulnerability: 'Weak Cookie',
        hints: [
          "Analyze stay-logged-in cookie",
          "Format: base64(username:md5(password))",
          "Generate for common passwords",
          "Base64 encode results",
          "Use cookie to login"
        ]
      }
    ],
    access: [
      {
        id: 'access-1',
        title: 'Unprotected admin panel',
        difficulty: 'apprentice',
        description: 'Admin panel has no auth.',
        objective: 'Access admin panel.',
        endpoint: '/administrator-panel',
        vulnerability: 'Missing Access Control',
        hints: [
          "Check robots.txt",
          "Guess common admin paths",
          "Navigate to /administrator-panel",
          "No authentication required",
          "Delete carlos user"
        ]
      },
      {
        id: 'access-2',
        title: 'User role parameter',
        difficulty: 'apprentice',
        description: 'Role controlled by request parameter.',
        objective: 'Escalate to admin role.',
        endpoint: '/admin',
        vulnerability: 'Parameter Manipulation',
        hints: [
          "Login with normal user",
          "Notice roleid parameter",
          "Change roleid to 2",
          "Admin access granted",
          "Delete carlos user"
        ]
      },
      {
        id: 'access-3',
        title: 'IDOR vulnerability',
        difficulty: 'apprentice',
        description: 'User ID not validated.',
        objective: 'Access other user data.',
        endpoint: '/my-account?id=',
        vulnerability: 'IDOR',
        hints: [
          "Your account has id parameter",
          "Change id to another user",
          "Try id=carlos",
          "Access carlos data",
          "Retrieve API key"
        ]
      },
      {
        id: 'access-4',
        title: 'Multi-step bypass',
        difficulty: 'practitioner',
        description: 'Missing validation in step 2.',
        objective: 'Escalate privileges.',
        endpoint: '/admin-roles',
        vulnerability: 'Multi-step Flaw',
        hints: [
          "Role change is 2-step",
          "Step 1 validates admin",
          "Step 2 doesn't validate",
          "Skip to step 2",
          "Privilege escalation!"
        ]
      }
    ],
    business: [
      {
        id: 'business-1',
        title: 'Client-side price manipulation',
        difficulty: 'apprentice',
        description: 'Price trusted from client.',
        objective: 'Buy expensive item cheaply.',
        endpoint: '/cart',
        vulnerability: 'Client-side Trust',
        hints: [
          "Add item to cart",
          "Intercept the request",
          "Price parameter is sent",
          "Change price to 0.01",
          "Purchase completed!"
        ]
      },
      {
        id: 'business-2',
        title: 'Negative quantity flaw',
        difficulty: 'apprentice',
        description: 'Quantity can be negative.',
        objective: 'Reduce total below zero.',
        endpoint: '/cart',
        vulnerability: 'Logic Flaw',
        hints: [
          "Add expensive item",
          "Add cheap item negative",
          "quantity=-999",
          "Total becomes negative",
          "Checkout successful"
        ]
      },
      {
        id: 'business-3',
        title: 'Email validation bypass',
        difficulty: 'apprentice',
        description: 'Admin domain check after registration.',
        objective: 'Gain admin access.',
        endpoint: '/register',
        vulnerability: 'Validation Bypass',
        hints: [
          "Register normal account",
          "Login successfully",
          "Change email to @dontwannacry.com",
          "Domain check after",
          "Admin panel accessible"
        ]
      },
      {
        id: 'business-4',
        title: 'Parameter injection',
        difficulty: 'practitioner',
        description: 'Hidden parameter accepted.',
        objective: 'Change admin password.',
        endpoint: '/change-password',
        vulnerability: 'Parameter Injection',
        hints: [
          "Change your password",
          "Add username parameter",
          "username=administrator",
          "Endpoint accepts it",
          "Admin password changed!"
        ]
      }
    ],
    ssrf: [
      {
        id: 'ssrf-1',
        title: 'SSRF to localhost',
        difficulty: 'apprentice',
        description: 'Access internal services.',
        objective: 'Access admin via localhost.',
        endpoint: '/product/stock',
        vulnerability: 'SSRF',
        hints: [
          "Stock check uses URL",
          "Try http://localhost/admin",
          "Internal services accessible",
          "Admin panel found",
          "Delete carlos user"
        ]
      },
      {
        id: 'ssrf-2',
        title: 'Internal network scan',
        difficulty: 'apprentice',
        description: 'Scan internal network.',
        objective: 'Find admin on internal IP.',
        endpoint: '/product/stock',
        vulnerability: 'SSRF Scan',
        hints: [
          "Try internal IPs",
          "192.168.0.1 to .255",
          "Look for different response",
          "Admin at 192.168.0.68",
          "Access internal admin"
        ]
      },
      {
        id: 'ssrf-3',
        title: 'SSRF filter bypass',
        difficulty: 'practitioner',
        description: 'Bypass localhost blacklist.',
        objective: 'Access blocked localhost.',
        endpoint: '/product/stock',
        vulnerability: 'Filter Bypass',
        hints: [
          "localhost is blocked",
          "Try alternatives",
          "Use 127.1 short form",
          "Or use 127.0.0.1",
          "Blacklist bypassed!"
        ]
      }
    ],
    xxe: [
      {
        id: 'xxe-1',
        title: 'XXE file disclosure',
        difficulty: 'apprentice',
        description: 'Read local files via XXE.',
        objective: 'Retrieve /etc/passwd.',
        endpoint: '/product/stock',
        vulnerability: 'XXE',
        hints: [
          "Stock check accepts XML",
          "Add DOCTYPE with entity",
          '<!ENTITY xxe SYSTEM "file:///etc/passwd">',
          "Reference &xxe; in XML",
          "File contents returned"
        ]
      },
      {
        id: 'xxe-2',
        title: 'XXE to SSRF',
        difficulty: 'apprentice',
        description: 'Use XXE for SSRF attack.',
        objective: 'Retrieve EC2 metadata.',
        endpoint: '/product/stock',
        vulnerability: 'XXE to SSRF',
        hints: [
          "XXE can make HTTP requests",
          "Target AWS metadata",
          "http://169.254.169.254/...",
          "Retrieve IAM credentials",
          "Sensitive data exposed"
        ]
      },
      {
        id: 'xxe-3',
        title: 'Blind XXE',
        difficulty: 'practitioner',
        description: 'XXE with no direct output.',
        objective: 'Trigger out-of-band request.',
        endpoint: '/product/stock',
        vulnerability: 'Blind XXE',
        hints: [
          "No direct response",
          "Use out-of-band",
          "External entity to your server",
          "Monitor HTTP/DNS requests",
          "Confirm XXE via logs"
        ]
      }
    ]
  };

  const difficultyColors = {
    apprentice: 'text-green-400 bg-green-500/10 border-green-500',
    practitioner: 'text-yellow-400 bg-yellow-500/10 border-yellow-500',
    expert: 'text-red-400 bg-red-500/10 border-red-500'
  };

  const topicColors = {
    red: 'from-red-500/20 to-red-600/20 border-red-500',
    orange: 'from-orange-500/20 to-orange-600/20 border-orange-500',
    yellow: 'from-yellow-500/20 to-yellow-600/20 border-yellow-500',
    green: 'from-green-500/20 to-green-600/20 border-green-500',
    blue: 'from-blue-500/20 to-blue-600/20 border-blue-500',
    purple: 'from-purple-500/20 to-purple-600/20 border-purple-500',
    cyan: 'from-cyan-500/20 to-cyan-600/20 border-cyan-500',
    pink: 'from-pink-500/20 to-pink-600/20 border-pink-500',
    gold: 'from-yellow-400/20 to-yellow-600/20 border-yellow-400',
    gray: 'from-gray-500/20 to-gray-600/20 border-gray-500'
  };

  const handleRegister = (e) => {
    e.preventDefault();
    setAuthError('');

    if (!authForm.username || !authForm.email || !authForm.password) {
      setAuthError('All fields are required');
      return;
    }

    if (authForm.password.length < 6) {
      setAuthError('Password must be at least 6 characters');
      return;
    }

    if (users.find(u => u.username === authForm.username)) {
      setAuthError('Username already exists');
      return;
    }

    const newUser = {
      id: Date.now().toString(),
      username: authForm.username,
      email: authForm.email,
      password: btoa(authForm.password),
      role: 'user',
      createdAt: new Date().toISOString(),
      avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${authForm.username}`,
      progress: {},
      stats: {
        completed: 0,
        total: 27,
        points: 0,
        rank: 'Beginner',
        streak: 0,
        achievements: [],
        lastActive: new Date().toDateString(),
        labTimes: {},
        hintsUsed: {}
      }
    };

    setUsers([...users, newUser]);
    const sessionUser = { ...newUser };
    delete sessionUser.password;
    setCurrentUser(sessionUser);
    setIsAuthenticated(true);
    setShowAuthModal(false);
    setAuthForm({ username: '', email: '', password: '' });
    setLabProgress({});
    setUserStats(newUser.stats);
  };

  const handleLogin = (e) => {
    e.preventDefault();
    setAuthError('');

    if (!authForm.username || !authForm.password) {
      setAuthError('Username and password are required');
      return;
    }

    const user = users.find(u => 
      u.username === authForm.username && 
      atob(u.password) === authForm.password
    );

    if (!user) {
      setAuthError('Invalid username or password');
      return;
    }

    const sessionUser = { ...user };
    delete sessionUser.password;
    setCurrentUser(sessionUser);
    setIsAuthenticated(true);
    setShowAuthModal(false);
    setAuthForm({ username: '', email: '', password: '' });
    setLabProgress(user.progress || {});
    setUserStats(user.stats);
  };

  const handleLogout = () => {
    setCurrentUser(null);
    setIsAuthenticated(false);
    setLabProgress({});
    setUserStats({
      completed: 0,
      total: 27,
      points: 0,
      rank: 'Beginner',
      streak: 0,
      achievements: [],
      lastActive: new Date().toDateString(),
      labTimes: {},
      hintsUsed: {}
    });
    setShowUserMenu(false);
  };

  const simulateLabResponse = (lab, method, path, body) => {
    const labId = lab.id;
    
    const exploitPatterns = {
      'sqli-1': path.includes("' OR 1=1--") || path.includes("' OR '1'='1"),
      'sqli-2': body.includes("administrator'--") || path.includes("administrator'--"),
      'sqli-3': path.includes("UNION SELECT NULL"),
      'sqli-4': path.includes("UNION SELECT") && (path.includes("users") || path.includes("username")),
      'xss-1': path.includes('<script>'),
      'xss-2': body.includes('<script>'),
      'xss-3': path.includes('"><script>'),
      'csrf-1': body.includes('email=') || path.includes('email='),
      'csrf-2': method === 'GET' && path.includes('email='),
      'auth-1': path.includes('carlos') || body.includes('carlos'),
      'auth-2': body.includes('username=carlos'),
      'auth-3': path.includes('/my-account'),
      'auth-4': body.includes('stay-logged-in') || path.includes('cookie'),
      'access-1': path.includes('administrator-panel'),
      'access-2': body.includes('roleid=2') || path.includes('roleid=2'),
      'access-3': path.includes('id=carlos'),
      'access-4': path.includes('confirm') || body.includes('confirm'),
      'business-1': body.includes('price=0') || path.includes('price=0'),
      'business-2': body.includes('quantity=-') || path.includes('quantity=-'),
      'business-3': body.includes('@dontwannacry.com'),
      'business-4': body.includes('username=administrator'),
      'ssrf-1': path.includes('localhost'),
      'ssrf-2': path.includes('192.168.0'),
      'ssrf-3': path.includes('127.1') || path.includes('127.0.0.1'),
      'xxe-1': body.includes('<!ENTITY') && body.includes('/etc/passwd'),
      'xxe-2': body.includes('169.254.169.254'),
      'xxe-3': body.includes('<!ENTITY') && body.includes('http://')
    };

    const isExploited = exploitPatterns[labId];

    if (isExploited) {
      const newProgress = { ...labProgress, [labId]: true };
      setLabProgress(newProgress);
      
      // Update user's progress in users array
      if (currentUser) {
        setUsers(users.map(u => 
          u.id === currentUser.id 
            ? { ...u, progress: newProgress }
            : u
        ));
      }
      
      const completedCount = Object.keys(newProgress).length;
      const newPoints = completedCount * 10;
      const timeElapsed = labStartTime ? Math.floor((Date.now() - labStartTime) / 1000) : 0;
      
      let newAchievements = [...userStats.achievements];
      let achievementUnlocked = null;

      if (completedCount === 1 && !newAchievements.includes('first_blood')) {
        newAchievements.push('first_blood');
        achievementUnlocked = achievements.find(a => a.id === 'first_blood');
      }

      if (timeElapsed > 0 && timeElapsed < 120 && !newAchievements.includes('speed_runner')) {
        newAchievements.push('speed_runner');
        achievementUnlocked = achievements.find(a => a.id === 'speed_runner');
      }

      const topicLabs = labs[selectedTopic];
      const topicCompleted = topicLabs.every(l => newProgress[l.id]);
      
      if (topicCompleted && selectedTopic === 'sqli' && !newAchievements.includes('sql_master')) {
        newAchievements.push('sql_master');
        achievementUnlocked = achievements.find(a => a.id === 'sql_master');
      }

      if (topicCompleted && selectedTopic === 'xss' && !newAchievements.includes('xss_ninja')) {
        newAchievements.push('xss_ninja');
        achievementUnlocked = achievements.find(a => a.id === 'xss_ninja');
      }

      if (completedCount === 27 && !newAchievements.includes('completionist')) {
        newAchievements.push('completionist');
        achievementUnlocked = achievements.find(a => a.id === 'completionist');
      }

      const newRank = ranks.find(r => newPoints >= r.min && newPoints <= r.max)?.name || 'Beginner';

      const newStats = {
        ...userStats,
        completed: completedCount,
        points: newPoints,
        rank: newRank,
        achievements: newAchievements,
        labTimes: { ...userStats.labTimes, [labId]: timeElapsed },
        hintsUsed: { ...userStats.hintsUsed, [labId]: hintsRevealed }
      };

      setUserStats(newStats);
      
      // Update user's stats in users array
      if (currentUser) {
        setUsers(users.map(u => 
          u.id === currentUser.id 
            ? { ...u, stats: newStats }
            : u
        ));
      }

      if (achievementUnlocked) {
        setShowAchievement(achievementUnlocked);
        setTimeout(() => setShowAchievement(null), 5000);
      }

      return {
        status: 200,
        success: true,
        message: 'üéâ Lab Completed!',
        data: {
          flag: `FLAG{${labId}_completed_${Date.now()}}`,
          points: 10,
          timeElapsed: timeElapsed,
          hintsUsed: hintsRevealed
        }
      };
    }

    return {
      status: 400,
      success: false,
      message: 'Exploitation attempt detected but incorrect',
      data: null
    };
  };

  const handleSubmitRequest = () => {
    if (!selectedLab) return;
    
    const response = simulateLabResponse(selectedLab, requestMethod, requestPath, requestBody);
    setResponseData(response);
    
    setTimeout(() => {
      responseRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, 100);
  };

  const startLab = (lab) => {
    setSelectedLab(lab);
    setLabStarted(true);
    setRequestPath(lab.endpoint);
    setRequestBody('');
    setResponseData(null);
    setShowSolution(false);
    setLabStartTime(Date.now());
    setHintsRevealed(0);
  };

  const resetLab = () => {
    setLabStarted(false);
    setSelectedLab(null);
    setRequestPath('');
    setRequestBody('');
    setResponseData(null);
    setShowSolution(false);
    setLabStartTime(null);
    setHintsRevealed(0);
  };

  useEffect(() => {
    let interval;
    if (labStarted && labStartTime) {
      interval = setInterval(() => {
        setLabTime(Math.floor((Date.now() - labStartTime) / 1000));
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [labStarted, labStartTime]);

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const currentRank = ranks.find(r => userStats.points >= r.min && userStats.points <= r.max);

  if (!isAuthenticated) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white p-8">
        <div className="max-w-6xl mx-auto">
          <div className="text-center mb-12">
            <div className="flex items-center justify-center gap-3 mb-4">
              <Shield className="w-16 h-16 text-purple-400" />
              <h1 className="text-6xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                CyberAcademy Pro
              </h1>
            </div>
            <p className="text-xl text-gray-300">Master Web Security Through Hands-On Labs</p>
          </div>

          <div className="grid md:grid-cols-2 gap-8 mb-12">
            <div className="bg-gray-800/50 backdrop-blur border border-gray-700 rounded-xl p-6">
              <Database className="w-12 h-12 text-red-400 mb-4" />
              <h3 className="text-xl font-bold mb-2">27 Interactive Labs</h3>
              <p className="text-gray-400">Practice SQL Injection, XSS, CSRF, and more</p>
            </div>
            <div className="bg-gray-800/50 backdrop-blur border border-gray-700 rounded-xl p-6">
              <Trophy className="w-12 h-12 text-yellow-400 mb-4" />
              <h3 className="text-xl font-bold mb-2">Earn Achievements</h3>
              <p className="text-gray-400">Track progress and compete on leaderboards</p>
            </div>
            <div className="bg-gray-800/50 backdrop-blur border border-gray-700 rounded-xl p-6">
              <Target className="w-12 h-12 text-blue-400 mb-4" />
              <h3 className="text-xl font-bold mb-2">Real-World Scenarios</h3>
              <p className="text-gray-400">Learn vulnerabilities from actual applications</p>
            </div>
            <div className="bg-gray-800/50 backdrop-blur border border-gray-700 rounded-xl p-6">
              <Zap className="w-12 h-12 text-green-400 mb-4" />
              <h3 className="text-xl font-bold mb-2">Instant Feedback</h3>
              <p className="text-gray-400">Get immediate validation on your exploits</p>
            </div>
          </div>

          <div className="flex gap-4 justify-center">
            <button
              onClick={() => { setShowAuthModal(true); setAuthMode('register'); }}
              className="px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-bold text-lg hover:from-purple-700 hover:to-pink-700 transition-all flex items-center gap-2"
            >
              <UserPlus className="w-5 h-5" />
              Get Started Free
            </button>
            <button
              onClick={() => { setShowAuthModal(true); setAuthMode('login'); }}
              className="px-8 py-4 bg-gray-700 rounded-lg font-bold text-lg hover:bg-gray-600 transition-all flex items-center gap-2"
            >
              <LogIn className="w-5 h-5" />
              Sign In
            </button>
          </div>
        </div>

        {showAuthModal && (
          <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-gray-800 border border-gray-700 rounded-xl p-8 max-w-md w-full">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold">
                  {authMode === 'login' ? 'Sign In' : 'Create Account'}
                </h2>
                <button onClick={() => setShowAuthModal(false)} className="text-gray-400 hover:text-white">
                  <X className="w-6 h-6" />
                </button>
              </div>

              <form onSubmit={authMode === 'login' ? handleLogin : handleRegister}>
                {authError && (
                  <div className="mb-4 p-3 bg-red-500/10 border border-red-500 rounded-lg text-red-400 text-sm">
                    {authError}
                  </div>
                )}

                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Username</label>
                    <input
                      type="text"
                      value={authForm.username}
                      onChange={(e) => setAuthForm({ ...authForm, username: e.target.value })}
                      className="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500"
                      placeholder="Enter username"
                    />
                  </div>

                  {authMode === 'register' && (
                    <div>
                      <label className="block text-sm font-medium mb-2">Email</label>
                      <input
                        type="email"
                        value={authForm.email}
                        onChange={(e) => setAuthForm({ ...authForm, email: e.target.value })}
                        className="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500"
                        placeholder="Enter email"
                      />
                    </div>
                  )}

                  <div>
                    <label className="block text-sm font-medium mb-2">Password</label>
                    <input
                      type="password"
                      value={authForm.password}
                      onChange={(e) => setAuthForm({ ...authForm, password: e.target.value })}
                      className="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500"
                      placeholder="Enter password"
                    />
                  </div>
                </div>

                <button
                  type="submit"
                  className="w-full mt-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-bold hover:from-purple-700 hover:to-pink-700 transition-all"
                >
                  {authMode === 'login' ? 'Sign In' : 'Create Account'}
                </button>
              </form>

              <div className="mt-4 text-center text-sm text-gray-400">
                {authMode === 'login' ? (
                  <span>
                    Don't have an account?{' '}
                    <button
                      onClick={() => { setAuthMode('register'); setAuthError(''); }}
                      className="text-purple-400 hover:text-purple-300"
                    >
                      Sign up
                    </button>
                  </span>
                ) : (
                  <span>
                    Already have an account?{' '}
                    <button
                      onClick={() => { setAuthMode('login'); setAuthError(''); }}
                      className="text-purple-400 hover:text-purple-300"
                    >
                      Sign in
                    </button>
                  </span>
                )}
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white">
      {/* Header */}
      <div className="border-b border-gray-800 bg-gray-900/50 backdrop-blur sticky top-0 z-40">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Shield className="w-8 h-8 text-purple-400" />
              <h1 className="text-2xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                CyberAcademy Pro
              </h1>
            </div>

            <div className="flex items-center gap-6">
              <div className="hidden md:flex items-center gap-4 text-sm">
                <div className="flex items-center gap-2">
                  <Trophy className="w-4 h-4 text-yellow-400" />
                  <span className="font-bold">{userStats.points}</span>
                  <span className="text-gray-400">points</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-2xl">{currentRank?.icon}</span>
                  <span className="font-bold">{currentRank?.name}</span>
                </div>
              </div>

              <div className="relative">
                <button
                  onClick={() => setShowUserMenu(!showUserMenu)}
                  className="flex items-center gap-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors"
                >
                  <img
                    src={currentUser?.avatar}
                    alt="avatar"
                    className="w-8 h-8 rounded-full"
                  />
                  <span className="font-medium">{currentUser?.username}</span>
                </button>

                {showUserMenu && (
                  <div className="absolute right-0 mt-2 w-48 bg-gray-800 border border-gray-700 rounded-lg shadow-xl">
                    <button
                      onClick={handleLogout}
                      className="w-full px-4 py-2 text-left hover:bg-gray-700 rounded-lg flex items-center gap-2 text-red-400"
                    >
                      <LogOut className="w-4 h-4" />
                      Sign Out
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>

          <div className="flex gap-2 mt-4">
            <button
              onClick={() => { setActiveTab('labs'); resetLab(); }}
              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                activeTab === 'labs'
                  ? 'bg-purple-600 text-white'
                  : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
              }`}
            >
              <Terminal className="w-4 h-4 inline mr-2" />
              Labs
            </button>
            <button
              onClick={() => { setActiveTab('progress'); resetLab(); }}
              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                activeTab === 'progress'
                  ? 'bg-purple-600 text-white'
                  : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
              }`}
            >
              <BarChart3 className="w-4 h-4 inline mr-2" />
              Progress
            </button>
            <button
              onClick={() => { setActiveTab('achievements'); resetLab(); }}
              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                activeTab === 'achievements'
                  ? 'bg-purple-600 text-white'
                  : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
              }`}
            >
              <Trophy className="w-4 h-4 inline mr-2" />
              Achievements
            </button>
          </div>
        </div>
      </div>

      {/* Achievement Popup */}
      {showAchievement && (
        <div className="fixed top-20 right-4 z-50 animate-bounce">
          <div className="bg-gradient-to-r from-yellow-500 to-orange-500 border-2 border-yellow-400 rounded-xl p-4 shadow-2xl max-w-sm">
            <div className="flex items-center gap-3">
              <showAchievement.icon className="w-12 h-12 text-white" />
              <div>
                <div className="font-bold text-lg text-white">Achievement Unlocked!</div>
                <div className="text-sm text-yellow-100">{showAchievement.name}</div>
                <div className="text-xs text-yellow-200">+{showAchievement.points} points</div>
              </div>
            </div>
          </div>
        </div>
      )}

      <div className="max-w-7xl mx-auto px-4 py-8">
        {/* Labs Tab */}
        {activeTab === 'labs' && !labStarted && (
          <div>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
              {topics.map((topic) => {
                const TopicIcon = topic.icon;
                const completed = labs[topic.id]?.filter(lab => labProgress[lab.id]).length || 0;
                return (
                  <button
                    key={topic.id}
                    onClick={() => setSelectedTopic(topic.id)}
                    className={`p-4 rounded-xl border-2 transition-all ${
                      selectedTopic === topic.id
                        ? `bg-gradient-to-br ${topicColors[topic.color]} border-opacity-100`
                        : 'bg-gray-800/50 border-gray-700 hover:border-gray-600'
                    }`}
                  >
                    <TopicIcon className="w-8 h-8 mb-2" />
                    <div className="font-bold text-sm">{topic.name}</div>
                    <div className="text-xs text-gray-400 mt-1">
                      {completed}/{topic.labs} completed
                    </div>
                  </button>
                );
              })}
            </div>

            <div className="space-y-4">
              {labs[selectedTopic]?.map((lab) => {
                const isCompleted = labProgress[lab.id];
                return (
                  <div
                    key={lab.id}
                    className="bg-gray-800/50 border border-gray-700 rounded-xl p-6 hover:border-gray-600 transition-all"
                  >
                    <div className="flex items-start justify-between mb-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-3 mb-2">
                          <h3 className="text-xl font-bold">{lab.title}</h3>
                          {isCompleted && <CheckCircle className="w-6 h-6 text-green-400" />}
                        </div>
                        <p className="text-gray-400 mb-3">{lab.description}</p>
                        <div className="flex items-center gap-4 text-sm">
                          <span className={`px-3 py-1 rounded-full border ${difficultyColors[lab.difficulty]}`}>
                            {lab.difficulty}
                          </span>
                          <span className="text-gray-500">{lab.vulnerability}</span>
                        </div>
                      </div>
                      <button
                        onClick={() => startLab(lab)}
                        className="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-bold hover:from-purple-700 hover:to-pink-700 transition-all flex items-center gap-2"
                      >
                        <Play className="w-4 h-4" />
                        Start Lab
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* Active Lab */}
        {activeTab === 'labs' && labStarted && selectedLab && (
          <div className="space-y-6">
            <div className="bg-gray-800/50 border border-gray-700 rounded-xl p-6">
              <div className="flex items-start justify-between mb-4">
                <div>
                  <h2 className="text-2xl font-bold mb-2">{selectedLab.title}</h2>
                  <p className="text-gray-400 mb-4">{selectedLab.description}</p>
                  <div className="flex items-center gap-4">
                    <span className={`px-3 py-1 rounded-full border text-sm ${difficultyColors[selectedLab.difficulty]}`}>
                      {selectedLab.difficulty}
                    </span>
                    <span className="text-gray-500 text-sm">{selectedLab.vulnerability}</span>
                    <div className="flex items-center gap-2 text-yellow-400">
                      <Clock className="w-4 h-4" />
                      <span className="font-mono">{formatTime(labTime)}</span>
                    </div>
                  </div>
                </div>
                <button
                  onClick={resetLab}
                  className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors flex items-center gap-2"
                >
                  <X className="w-4 h-4" />
                  Exit Lab
                </button>
              </div>

              <div className="bg-blue-500/10 border border-blue-500 rounded-lg p-4 mb-4">
                <div className="flex items-start gap-2">
                  <Target className="w-5 h-5 text-blue-400 mt-0.5" />
                  <div>
                    <div className="font-bold text-blue-400 mb-1">Objective</div>
                    <div className="text-sm">{selectedLab.objective}</div>
                  </div>
                </div>
              </div>

              <div className="space-y-2">
                <div className="font-bold flex items-center gap-2">
                  <Beaker className="w-4 h-4" />
                  Hints ({hintsRevealed}/{selectedLab.hints.length})
                </div>
                {selectedLab.hints.map((hint, idx) => (
                  <div key={idx}>
                    {idx < hintsRevealed ? (
                      <div className="bg-gray-700/50 border border-gray-600 rounded-lg p-3 text-sm">
                        {hint}
                      </div>
                    ) : idx === hintsRevealed ? (
                      <button
                        onClick={() => setHintsRevealed(hintsRevealed + 1)}
                        className="w-full bg-gray-700 hover:bg-gray-600 border border-gray-600 rounded-lg p-3 text-sm transition-colors flex items-center justify-center gap-2"
                      >
                        <Eye className="w-4 h-4" />
                        Reveal Hint {idx + 1}
                      </button>
                    ) : null}
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-gray-800/50 border border-gray-700 rounded-xl p-6">
              <div className="font-bold mb-4 flex items-center gap-2">
                <Terminal className="w-5 h-5" />
                HTTP Request Builder
              </div>

              <div className="space-y-4">
                <div className="flex gap-4">
                  <select
                    value={requestMethod}
                    onChange={(e) => setRequestMethod(e.target.value)}
                    className="px-4 py-2 bg-gray-900 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500"
                  >
                    <option>GET</option>
                    <option>POST</option>
                    <option>PUT</option>
                    <option>DELETE</option>
                  </select>
                  <input
                    type="text"
                    value={requestPath}
                    onChange={(e) => setRequestPath(e.target.value)}
                    className="flex-1 px-4 py-2 bg-gray-900 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 font-mono text-sm"
                    placeholder="/endpoint?param=value"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">Headers</label>
                  <textarea
                    value={requestHeaders}
                    onChange={(e) => setRequestHeaders(e.target.value)}
                    className="w-full px-4 py-2 bg-gray-900 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 font-mono text-sm"
                    rows="3"
                  />
                </div>

                {(requestMethod === 'POST' || requestMethod === 'PUT') && (
                  <div>
                    <label className="block text-sm font-medium mb-2">Request Body</label>
                    <textarea
                      value={requestBody}
                      onChange={(e) => setRequestBody(e.target.value)}
                      className="w-full px-4 py-2 bg-gray-900 border border-gray-600 rounded-lg focus:outline-none focus:border-purple-500 font-mono text-sm"
                      rows="6"
                      placeholder="username=admin&password=123"
                    />
                  </div>
                )}

                <button
                  onClick={handleSubmitRequest}
                  className="w-full py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 rounded-lg font-bold transition-all flex items-center justify-center gap-2"
                >
                  <Send className="w-4 h-4" />
                  Send Request
                </button>
              </div>
            </div>

            {responseData && (
              <div ref={responseRef} className="bg-gray-800/50 border border-gray-700 rounded-xl p-6">
                <div className="font-bold mb-4 flex items-center gap-2">
                  <Terminal className="w-5 h-5" />
                  Response
                </div>

                <div className={`border-2 rounded-lg p-4 mb-4 ${
                  responseData.success
                    ? 'bg-green-500/10 border-green-500'
                    : 'bg-red-500/10 border-red-500'
                }`}>
                  <div className="flex items-center gap-2 mb-2">
                    {responseData.success ? (
                      <CheckCircle className="w-6 h-6 text-green-400" />
                    ) : (
                      <AlertTriangle className="w-6 h-6 text-red-400" />
                    )}
                    <span className="font-bold">{responseData.message}</span>
                  </div>
                  
                  {responseData.data && (
                    <div className="mt-4 space-y-2">
                      <div className="bg-gray-900 rounded p-3 font-mono text-sm">
                        <div className="text-green-400">Flag: {responseData.data.flag}</div>
                        <div className="text-yellow-400">Points Earned: +{responseData.data.points}</div>
                        <div className="text-blue-400">Time: {formatTime(responseData.data.timeElapsed)}</div>
                        <div className="text-purple-400">Hints Used: {responseData.data.hintsUsed}</div>
                      </div>
                    </div>
                  )}
                </div>

                {responseData.success && (
                  <div className="flex gap-4">
                    <button
                      onClick={resetLab}
                      className="flex-1 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold transition-colors"
                    >
                      Next Lab
                    </button>
                  </div>
                )}
              </div>
            )}
          </div>
        )}

        {/* Progress Tab */}
        {activeTab === 'progress' && (
          <div className="space-y-6">
            <div className="grid md:grid-cols-3 gap-6">
              <div className="bg-gradient-to-br from-purple-500/20 to-purple-600/20 border-2 border-purple-500 rounded-xl p-6">
                <div className="flex items-center gap-3 mb-2">
                  <Trophy className="w-8 h-8 text-purple-400" />
                  <div className="text-3xl font-bold">{userStats.points}</div>
                </div>
                <div className="text-gray-400">Total Points</div>
              </div>

              <div className="bg-gradient-to-br from-green-500/20 to-green-600/20 border-2 border-green-500 rounded-xl p-6">
                <div className="flex items-center gap-3 mb-2">
                  <CheckCircle className="w-8 h-8 text-green-400" />
                  <div className="text-3xl font-bold">{userStats.completed}/{userStats.total}</div>
                </div>
                <div className="text-gray-400">Labs Completed</div>
              </div>

              <div className="bg-gradient-to-br from-yellow-500/20 to-yellow-600/20 border-2 border-yellow-500 rounded-xl p-6">
                <div className="flex items-center gap-3 mb-2">
                  <span className="text-4xl">{currentRank?.icon}</span>
                  <div className="text-2xl font-bold">{currentRank?.name}</div>
                </div>
                <div className="text-gray-400">Current Rank</div>
              </div>
            </div>

            <div className="bg-gray-800/50 border border-gray-700 rounded-xl p-6">
              <h3 className="text-xl font-bold mb-4">Progress by Topic</h3>
              <div className="space-y-4">
                {topics.map((topic) => {
                  const completed = labs[topic.id]?.filter(lab => labProgress[lab.id]).length || 0;
                  const total = topic.labs;
                  const percentage = (completed / total) * 100;
                  return (
                    <div key={topic.id}>
                      <div className="flex items-center justify-between mb-2">
                        <span className="font-medium">{topic.name}</span>
                        <span className="text-sm text-gray-400">{completed}/{total}</span>
                      </div>
                      <div className="w-full bg-gray-700 rounded-full h-2">
                        <div
                          className={`h-2 rounded-full bg-gradient-to-r ${topicColors[topic.color].split(' ')[0]}`}
                          style={{ width: `${percentage}%` }}
                        />
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {/* Achievements Tab */}
        {activeTab === 'achievements' && (
          <div className="grid md:grid-cols-2 gap-6">
            {achievements.map((achievement) => {
              const isUnlocked = userStats.achievements.includes(achievement.id);
              const AchievementIcon = achievement.icon;
              return (
                <div
                  key={achievement.id}
                  className={`rounded-xl p-6 border-2 transition-all ${
                    isUnlocked
                      ? `bg-gradient-to-br ${topicColors[achievement.color]} border-opacity-100`
                      : 'bg-gray-800/50 border-gray-700 opacity-50'
                  }`}
                >
                  <div className="flex items-start gap-4">
                    <AchievementIcon className="w-12 h-12" />
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <h3 className="text-xl font-bold">{achievement.name}</h3>
                        {isUnlocked && <CheckCircle className="w-5 h-5 text-green-400" />}
                      </div>
                      <p className="text-gray-400 text-sm mb-3">{achievement.desc}</p>
                      <div className="flex items-center gap-2">
                        <Star className="w-4 h-4 text-yellow-400" />
                        <span className="font-bold text-yellow-400">+{achievement.points} points</span>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
};

export default CyberAcademyPro;